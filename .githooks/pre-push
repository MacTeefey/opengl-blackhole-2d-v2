#!/bin/bash
#
# Pre-push hook: Verify code compiles before pushing
#
# This hook runs automatically before 'git push' to ensure your code compiles.
# It prevents pushing broken code that would fail the remote build.
#
# To disable this hook temporarily: git push --no-verify
#

set -e
set -o pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo ""
printf "${YELLOW}=== Pre-push: Verifying code compiles ===${NC}\n"
echo ""

# Navigate to repository root
cd "$(git rev-parse --show-toplevel)"

# Check for CMake
if ! command -v cmake >/dev/null 2>&1; then
    printf "${RED}Error: CMake is not installed${NC}\n"
    echo "Skipping pre-push compilation check..."
    exit 0  # Don't block push if cmake isn't installed
fi

# Check for C++ compiler
if ! command -v c++ >/dev/null 2>&1 && ! command -v g++ >/dev/null 2>&1 && ! command -v clang++ >/dev/null 2>&1; then
    printf "${RED}Error: No C++ compiler found${NC}\n"
    echo "Skipping pre-push compilation check..."
    exit 0  # Don't block push if compiler isn't installed
fi

# Check for skip marker (used by starter steps with intentionally incomplete code)
# Delete marker after use so solution commits get validated
if [ -f ".skip-compile-check" ]; then
    printf "${YELLOW}Starter step - skipping compilation check (one-time)${NC}\n"
    rm ".skip-compile-check"
    echo ""
    exit 0
fi

# Create build directory if it doesn't exist
mkdir -p build
cd build

# Configure with CMake (suppress most output for cleaner hook output)
echo "Configuring..."

# Try to use vcpkg if VCPKG_ROOT is set
CMAKE_ARGS=""
if [ -n "$VCPKG_ROOT" ] && [ -f "$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" ]; then
    CMAKE_ARGS="-DCMAKE_TOOLCHAIN_FILE=$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake"
fi

if ! cmake .. $CMAKE_ARGS >/dev/null 2>&1; then
    echo ""
    printf "${RED}Error: CMake configuration failed${NC}\n"
    echo ""
    echo "Run ./run.sh to see detailed error messages."
    echo "To push anyway: git push --no-verify"
    echo ""
    exit 1
fi

# Build the project
echo "Compiling..."
if ! cmake --build . 2>&1 | tail -20; then
    echo ""
    printf "${RED}Error: Compilation failed${NC}\n"
    echo ""
    echo "Fix the compilation errors above before pushing."
    echo "To push anyway: git push --no-verify"
    echo ""
    exit 1
fi

echo ""
printf "${GREEN}=== Compilation successful! Pushing... ===${NC}\n"
echo ""

exit 0
